# ğŸ—ï¸ Arquitectura del Sistema RAG - v2.0

## Vista General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (React + TS)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ChatPanel   â”‚  â”‚ DocumentView â”‚  â”‚  Header      â”‚          â”‚
â”‚  â”‚ (Historial)  â”‚  â”‚ (PDF/MD/TXT) â”‚  â”‚ + StatusBadgeâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                     â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚          SettingsModal (Dashboard)             â”‚            â”‚
â”‚  â”‚  ğŸ“Š Stats  â”‚  ğŸ’¾ Cache  â”‚  ğŸ“š Documents       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚         SourcesSelect (Enriquecido)            â”‚            â”‚
â”‚  â”‚  ğŸ“š Todos | ğŸ“„ doc1.pdf (50 chunks)           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚         MarkdownRenderer (ReactMarkdown)       â”‚            â”‚
â”‚  â”‚  Listas, Negrita, CÃ³digo, Tablas...           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP/REST + SSE
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BACKEND (FastAPI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 API Endpoints                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  POST /ask          â†’ Query con respuesta normal         â”‚   â”‚
â”‚  â”‚  POST /ask/stream   â†’ Query con SSE (token-by-token)     â”‚   â”‚
â”‚  â”‚  GET  /health       â†’ Estado del sistema                 â”‚   â”‚
â”‚  â”‚  GET  /stats        â†’ EstadÃ­sticas (docs, chunks, etc)   â”‚   â”‚
â”‚  â”‚  GET  /cache/stats  â†’ MÃ©tricas del cachÃ©                 â”‚   â”‚
â”‚  â”‚  GET  /documents    â†’ Lista de documentos indexados      â”‚   â”‚
â”‚  â”‚  POST /ingest       â†’ Subir y procesar documentos        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              QueryCache (Thread-safe LRU)                â”‚   â”‚
â”‚  â”‚  â€¢ TTL configurable                                      â”‚   â”‚
â”‚  â”‚  â€¢ InvalidaciÃ³n automÃ¡tica tras ingesta                 â”‚   â”‚
â”‚  â”‚  â€¢ Hit rate tracking                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              RAG Core (rag.py)                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. BÃºsqueda HÃ­brida                                     â”‚   â”‚
â”‚  â”‚     â€¢ FAISS (vector search)                              â”‚   â”‚
â”‚  â”‚     â€¢ BM25 (keyword search)                              â”‚   â”‚
â”‚  â”‚     â€¢ Union + Dedup                                      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  2. Filtrado (opcional)                                  â”‚   â”‚
â”‚  â”‚     â€¢ source=None     â†’ TODO el corpus                   â”‚   â”‚
â”‚  â”‚     â€¢ source="doc"    â†’ Un documento especÃ­fico          â”‚   â”‚
â”‚  â”‚     â€¢ search_mode     â†’ single/multi/auto                â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  3. DiversificaciÃ³n (si multi-doc)                       â”‚   â”‚
â”‚  â”‚     â€¢ Balanceo round-robin entre fuentes                 â”‚   â”‚
â”‚  â”‚     â€¢ Evita sesgo hacia docs grandes                     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  4. Reranking                                            â”‚   â”‚
â”‚  â”‚     â€¢ Cross-encoder (jina-reranker-v2)                   â”‚   â”‚
â”‚  â”‚     â€¢ Top-k final                                        â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  5. Prompt Building                                      â”‚   â”‚
â”‚  â”‚     â€¢ Token clipping (llama.tokenize)                    â”‚   â”‚
â”‚  â”‚     â€¢ Mistral-Instruct format [INST]...[/INST]           â”‚   â”‚
â”‚  â”‚     â€¢ Anti-hallucination guardrails                      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  6. LLM Generation                                       â”‚   â”‚
â”‚  â”‚     â€¢ Temperatura auto-detectada                         â”‚   â”‚
â”‚  â”‚       - Factual: 0.0 (RUC, fecha, nÃºmeros)               â”‚   â”‚
â”‚  â”‚       - Balanceado: 0.3 (resumen, anÃ¡lisis)              â”‚   â”‚
â”‚  â”‚       - Creativo: 0.7 (sugerencias, ideas)               â”‚   â”‚
â”‚  â”‚     â€¢ Streaming opcional (SSE)                           â”‚   â”‚
â”‚  â”‚     â€¢ Safe max_tokens (no overflow)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Ingestion Pipeline (ingest.py)                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. File Extraction (paralelo)                           â”‚   â”‚
â”‚  â”‚     â€¢ PDF â†’ PyMuPDF (layout-aware)                       â”‚   â”‚
â”‚  â”‚     â€¢ MD â†’ markdown + BeautifulSoup                      â”‚   â”‚
â”‚  â”‚     â€¢ TXT â†’ directo                                      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  2. Cleaning                                             â”‚   â”‚
â”‚  â”‚     â€¢ Strip headers/footers repetidos                    â”‚   â”‚
â”‚  â”‚     â€¢ NormalizaciÃ³n de espacios                          â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  3. Smart Chunking                                       â”‚   â”‚
â”‚  â”‚     â€¢ Split por oraciones                                â”‚   â”‚
â”‚  â”‚     â€¢ Overlap configurable                               â”‚   â”‚
â”‚  â”‚     â€¢ Respeta lÃ­mite de tamaÃ±o                           â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  4. DeduplicaciÃ³n                                        â”‚   â”‚
â”‚  â”‚     â€¢ Hash: (source, page, text)                         â”‚   â”‚
â”‚  â”‚     â€¢ Intra-batch + vs Ã­ndice previo                     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  5. Embedding                                            â”‚   â”‚
â”‚  â”‚     â€¢ Model: intfloat/multilingual-e5-base               â”‚   â”‚
â”‚  â”‚     â€¢ Wrapper: "passage: {text}"                         â”‚   â”‚
â”‚  â”‚     â€¢ Batch processing                                   â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  6. Indexing                                             â”‚   â”‚
â”‚  â”‚     â€¢ FAISS IndexFlatIP (cosine similarity)              â”‚   â”‚
â”‚  â”‚     â€¢ Incremental update o rebuild                       â”‚   â”‚
â”‚  â”‚     â€¢ Meta persistence (chunks, sources, pages)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ data/docs/   â”‚  â”‚ data/store/  â”‚  â”‚ data/models/ â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ â€¢ PDFs       â”‚  â”‚ faiss.index  â”‚  â”‚ LLM (GGUF)   â”‚          â”‚
â”‚  â”‚ â€¢ Markdowns  â”‚  â”‚ meta.json    â”‚  â”‚ Embedder     â”‚          â”‚
â”‚  â”‚ â€¢ TXT files  â”‚  â”‚ embed_cache/ â”‚  â”‚ (HF cache)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de Query (Normal)

```
Usuario pregunta "Â¿CuÃ¡l es el RUC?"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. FRONTEND: ChatPanel                                          â”‚
â”‚    â€¢ Valida pregunta                                            â”‚
â”‚    â€¢ Agrega mensaje de usuario al historial                    â”‚
â”‚    â€¢ EnvÃ­a POST /ask                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BACKEND: app.py                                              â”‚
â”‚    â€¢ Revisa cachÃ© (query, source) â†’ HIT? devuelve cached       â”‚
â”‚    â€¢ Si MISS, continÃºa...                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. RAG: RecuperaciÃ³n                                            â”‚
â”‚    a) Embedding de query                                        â”‚
â”‚    b) FAISS search (top 80)                                     â”‚
â”‚    c) BM25 search (top 60)                                      â”‚
â”‚    d) Union + dedup                                             â”‚
â”‚    e) Filtro por source (si aplica)                             â”‚
â”‚    f) DiversificaciÃ³n (si multi-doc)                            â”‚
â”‚    g) Cross-encoder rerank â†’ top-k=6                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RAG: Temperatura                                             â”‚
â”‚    â€¢ Auto-detecta por heurÃ­sticas:                              â”‚
â”‚      - "cuÃ¡l", "quÃ©", nÃºmeros â†’ 0.0 (factual)                   â”‚
â”‚      - "explica", "resume" â†’ 0.3 (balanceado)                   â”‚
â”‚      - "sugiere" â†’ 0.7 (creativo)                               â”‚
â”‚    â€¢ O usa temperatura manual si se especificÃ³                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RAG: Prompt Building                                         â”‚
â”‚    â€¢ Format: [INST] <<SYS>>...contexto...<</SYS>> [/INST]       â”‚
â”‚    â€¢ Token clipping (65% N_CTX para prompt, 35% para respuesta)â”‚
â”‚    â€¢ Guardrails anti-alucinaciÃ³n                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. LLM: GeneraciÃ³n                                              â”‚
â”‚    â€¢ llama.cpp (Mistral-7B-Instruct-Q4_K_M)                     â”‚
â”‚    â€¢ max_tokens = safe_calc(N_CTX - prompt_tokens)              â”‚
â”‚    â€¢ temperature = auto-detectada                               â”‚
â”‚    â€¢ stop = ["</s>"]                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. BACKEND: Respuesta                                           â”‚
â”‚    â€¢ Construye AskResponse:                                     â”‚
â”‚      - answer: texto generado                                   â”‚
â”‚      - citations: [chunk_id, score, text, page, source]         â”‚
â”‚      - cached: false                                            â”‚
â”‚      - search_mode_used: "single"                               â”‚
â”‚      - temperature_used: 0.0                                    â”‚
â”‚    â€¢ Cachea respuesta                                           â”‚
â”‚    â€¢ Devuelve JSON                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. FRONTEND: Muestra                                            â”‚
â”‚    â€¢ Agrega mensaje de asistente al historial                  â”‚
â”‚    â€¢ Renderiza con MarkdownRenderer                             â”‚
â”‚    â€¢ Muestra metadata (temp, modo, cachÃ©)                       â”‚
â”‚    â€¢ Lista citas con click-to-jump                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ Flujo de Query (Streaming SSE)

```
Usuario pregunta (mismo input)
    â”‚
    â–¼
POST /ask/stream
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BACKEND: GeneraciÃ³n Streaming                                   â”‚
â”‚                                                                   â”‚
â”‚  event: metadata                                                â”‚
â”‚  data: {"cached": false, "search_mode": "single", "temp": 0.0} â”‚
â”‚                                                                   â”‚
â”‚  event: token                                                   â”‚
â”‚  data: {"token": "El", "done": false}                           â”‚
â”‚                                                                   â”‚
â”‚  event: token                                                   â”‚
â”‚  data: {"token": " RUC", "done": false}                         â”‚
â”‚                                                                   â”‚
â”‚  event: token                                                   â”‚
â”‚  data: {"token": " es", "done": false}                          â”‚
â”‚                                                                   â”‚
â”‚  ... mÃ¡s tokens ...                                             â”‚
â”‚                                                                   â”‚
â”‚  event: citations                                               â”‚
â”‚  data: [{...}, {...}]                                            â”‚
â”‚                                                                   â”‚
â”‚  event: done                                                    â”‚
â”‚  data: {"done": true}                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
FRONTEND: EventSource listener
    â€¢ Recibe tokens â†’ append a respuesta
    â€¢ UX tipo ChatGPT (typing effect)
    â€¢ Al final, muestra citas
```

---

## ğŸ—‚ï¸ Estructura de Datos

### Message (Frontend)
```typescript
{
  id: "user-1697123456789",
  role: "user" | "assistant",
  content: "Â¿CuÃ¡l es el RUC?",
  citations: [...],
  timestamp: Date,
  cached: false,
  searchMode: "single",
  temperature: 0.0
}
```

### Citation
```typescript
{
  id: 42,                    // Ãndice en el vector store
  score: 0.85,               // Similaridad (0-1)
  text: "RUC: 1234567890",   // Fragmento (max 400 chars)
  page: 1,                   // NÃºmero de pÃ¡gina (PDF)
  source: "factura.pdf"      // Nombre del archivo
}
```

### AskRequest
```python
{
  "question": "Â¿CuÃ¡l es el RUC?",
  "source": "factura.pdf",      # None para TODO el corpus
  "temperature": 0.0,           # None para auto-detect
  "search_mode": "auto"         # single/multi/auto
}
```

### AskResponse
```python
{
  "answer": "El RUC es...",
  "citations": [...],
  "cached": false,
  "search_mode_used": "single",
  "temperature_used": 0.0
}
```

---

## ğŸ” Seguridad

### Validaciones (Pydantic)
```python
question: min_length=3, max_length=500
source: sanitizaciÃ³n (no .., /, \)
temperature: ge=0.0, le=2.0
```

### Rate Limiting
```python
@limiter.limit("10/minute")  # Por IP
```

### CORS
```python
allow_origins = ["http://localhost:5173"]  # EspecÃ­ficos
```

---

## âš™ï¸ ConfiguraciÃ³n (.env)

```bash
# Modelos
EMBEDDING_MODEL_ID=intfloat/multilingual-e5-base
LLM_MODEL_PATH=data/models/llm/mistral-7b-instruct-q4_k_m.gguf

# RAG
TOP_K=6
N_CTX=4096
TEMPERATURE=0.0  # Default (ahora auto-detect)

# CachÃ©
ENABLE_CACHE=true
CACHE_TTL_SECONDS=300
CACHE_MAX_SIZE=100

# Seguridad
RATE_LIMIT_PER_MINUTE=10
MAX_FILE_SIZE_MB=50
```

---

## ğŸ“Š MÃ©tricas Clave

### Performance
- **Latencia sin cachÃ©**: 2-10s (depende del corpus)
- **Latencia con cachÃ©**: <100ms
- **Tokens/segundo (streaming)**: ~20-30 (CPU)

### Calidad
- **Hit rate cachÃ©**: >50% (con uso frecuente)
- **Cross-encoder accuracy**: >85% top-3
- **Temperature auto-detect**: >90% accuracy

---

## ğŸ¯ Decisiones de DiseÃ±o

### Â¿Por quÃ© E5-base?
- âœ… MultilingÃ¼e (espaÃ±ol + inglÃ©s)
- âœ… Dim=768 (balance size/quality)
- âœ… SOTA en benchmarks multilingÃ¼es

### Â¿Por quÃ© Mistral-7B-Instruct?
- âœ… PequeÃ±o pero potente (7B params)
- âœ… Cuantizado Q4_K_M (4GB RAM)
- âœ… Instruct-tuned (sigue instrucciones)

### Â¿Por quÃ© FAISS IndexFlatIP?
- âœ… Exacto (no approximate)
- âœ… RÃ¡pido para corpus <100k chunks
- âœ… Cosine similarity nativa

### Â¿Por quÃ© BM25 + FAISS?
- âœ… Complementarios (semÃ¡ntico + keywords)
- âœ… Mejor recall que solo uno
- âœ… Robusto ante queries ambiguas

### Â¿Por quÃ© Cross-encoder?
- âœ… Mejor precisiÃ³n que bi-encoder solo
- âœ… Jina-reranker-v2 multilingÃ¼e
- âœ… Costo aceptable para top-k pequeÃ±o

---

*Arquitectura v2.0 - Octubre 2025*
